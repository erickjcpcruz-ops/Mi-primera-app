<div id="video-box" style="display:none; margin-bottom: 20px;">
    <video id="reproductor" width="100%" controls disablePictureInPicture controlsList="nodownload">
        <source src="TU_VIDEO_AQUI.mp4" type="video/mp4">
    </video>
</div>

<script>
  const video = document.getElementById('reproductor');
  const videoBox = document.getElementById('video-box');

  async function mostrarAnuncio() {
    // Mostramos el video y ocultamos el botón para que no hagan trampa
    videoBox.style.display = 'block';
    video.play();
    
    // Deshabilitamos el botón de Telegram mientras ve el video
    window.Telegram.WebApp.MainButton.hide();
  }

  // EVENTO CLAVE: Solo ocurre al terminar el video
  video.onended = async function() {
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user;
    const userId = user ? user.id : 999; // <--- AQUÍ SE USA SU ID REAL

    saldo += 50;
    document.getElementById('balance').innerText = saldo;
    videoBox.style.display = 'none';

    // Guardamos en Supabase vinculando los puntos a SU ID
    const { error } = await _supabase
      .from('posts')
      .upsert({ 
        telegram_user_id: userId, 
        total_points: saldo,
        content: "Video completado por: " + (user ? user.first_name : "Humano")
      }, { onConflict: 'telegram_user_id' });

    if (!error) {
        tg.HapticFeedback.notificationOccurred('success'); // Vibra el cel
        tg.MainButton.setText("¡+50 PUNTOS RECLAMADOS!").show();
    }
  };
</script>
