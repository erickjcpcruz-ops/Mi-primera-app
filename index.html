<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // 2. Conexión a tu base de datos (Aquí incluimos tu clave real)
  const _supabaseUrl = 'https://ztoscymfplscnyybzzij.supabase.co';
  const _supabaseKey = 'TU_ANON_KEY_DE_SUPABASE'; // <--- BORRA ESTO Y PEGA TU LLAVE LARGA (eyJ...)
  const _supabase = supabase.createClient(_supabaseUrl, _supabaseKey);

  let saldo = 0;

  async function mostrarAnuncio() {
    // 3. Detectamos al usuario real de Telegram automáticamente
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe?.user;
    // Si no hay usuario de Telegram (ej. pruebas en PC), usamos 999
    const userId = user ? user.id : 999; 

    saldo += 50;
    document.getElementById('balance').innerText = saldo;

    // 4. Guardamos en la tabla 'posts' usando la lógica de Worldcoin
    const { error } = await _supabase
      .from('posts')
      .upsert({ 
        telegram_user_id: userId, 
        total_points: saldo,
        content: "Humano verificado: " + (user ? user.first_name : "Web") 
      }, { onConflict: 'telegram_user_id' });

    if (error) {
      console.error("Error al guardar:", error.message);
    } else {
      // Feedback visual para el usuario en Telegram
      tg.MainButton.setText("¡PUNTOS GUARDADOS!").show();
      setTimeout(() => tg.MainButton.hide(), 2000);
    }
  }
</script>


